
package <%=packageName%>.service;

import <%=packageName%>.domain.User;
import <%=packageName%>.security.BCryptPasswordHasher;
import <%=packageName%>.security.UserNotActivatedException;
import <%=packageName%>.security.UsernameNotFoundException;

import java.util.Locale;
import java.util.stream.Collectors;
import javax.enterprise.context.ApplicationScoped;
import javax.inject.Inject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@ApplicationScoped
public class AuthenticationService {
    private final Logger log = LoggerFactory.getLogger(AuthenticationService.class);

    public static final String emailValidator =
        "^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$";

    final BCryptPasswordHasher passwordHasher;


    @Inject
    public AuthenticationService(BCryptPasswordHasher passwordHasher) {
        this.passwordHasher = passwordHasher;
    }

    public SecurityIdentity authenticate(String login, String password) {
        User user = loadByUsername(login);
        if (!user.activated) {
            throw new UserNotActivatedException("User " + login + " was not activated");
        }
        if (passwordHasher.checkPassword(password, user.password)) {
            return createSecurityIdentity(user);
        }
        log.debug("Authentication failed: password does not match stored value");
        throw new AuthenticationFailedException("Authentication failed: password does not match stored value");
    }

    private User loadByUsername(String login) {
        log.debug("Authenticating {}", login);

        if (login.matches(emailValidator)) {

            return User
                .findOneWithAuthoritiesByEmailIgnoreCase(login)
                .orElseThrow(() -> new UsernameNotFoundException("User with email " + login + " was not found in the database"));
        }
        String lowercaseLogin = login.toLowerCase(Locale.ENGLISH);

        return User
            .findOneWithAuthoritiesByLogin(lowercaseLogin)
            .orElseThrow(() -> new UsernameNotFoundException("User " + lowercaseLogin + " was not found in the database"));
    }

    private SecurityIdentity createSecurityIdentity(User user) {
        SecurityIdentity.Builder builder = SecurityIdentity.builder();
        builder.setPrincipal(new Principal(user.login));
        builder.addCredential(new PasswordCredential(user.password.toCharArray()));
        builder.addRoles(user.authorities.stream().map(authority -> authority.name).collect(Collectors.toSet()));
        return builder.build();
    }
}
